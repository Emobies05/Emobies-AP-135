name: Emowall Pro Build

on:
  push:
    branches:
      - Emowall-Ai-2.0
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.2'
          cache: true

      - name: Specialist Cleanup & Reset
        run: |
          rm -rf android
          flutter create . --platforms=android --org com.emobies --project-name emowall

      - name: Add Missing Packages
        run: |
          # കോഡിന് ആവശ്യമുള്ള പാക്കേജുകൾ എല്ലാം ആഡ് ചെയ്യുന്നു
          flutter pub add speech_to_text audioplayers flutter_tts sensors_plus flutter_local_notifications url_launcher
          flutter pub get

      - name: FIND THE EXACT ERROR (Flutter Analyze)
        run: |
          # നിങ്ങളുടെ കോഡിൽ എവിടെയാണ് തെറ്റുള്ളതെന്ന് ഇത് കൃത്യമായി കണ്ടുപിടിക്കും
          flutter analyze

      - name: Android 15 & Permissions Fix
        run: |
          mkdir -p android/app/src/main/kotlin/com/emobies/emowall/
          cat > android/app/src/main/kotlin/com/emobies/emowall/MainActivity.kt << 'EOF'
          package com.emobies.emowall
          import io.flutter.embedding.android.FlutterFragmentActivity
          class MainActivity: FlutterFragmentActivity()
          EOF

          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.emobies.emowall">
              <application
                  android:label="Emowall Pro"
                  android:name="${applicationName}"
                  android:icon="@mipmap/ic_launcher">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|screenLayout|density|fontScale"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  <meta-data android:name="flutterEmbedding" android:value="2"/>
              </application>
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.RECORD_AUDIO"/>
              <uses-permission android:name="android.permission.BLUETOOTH"/>
              <uses-permission android:name="android.permission.BLUETOOTH_ADMIN"/>
              <uses-permission android:name="android.permission.BLUETOOTH_CONNECT"/>
          </manifest>
          EOF

      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Emowall-Pro-Release
          path: build/app/outputs/flutter-apk/app-release.apk
